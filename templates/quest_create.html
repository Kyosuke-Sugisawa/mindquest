{% extends "base.html" %}
{% block title %}クエスト作成{% endblock %}

{% block content %}
<style>
  .form-container {
    max-width: 1000px;
    margin: 0 auto;
    background-color: #fff;
    padding: 2em;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  .form-container h2 {
    text-align: center;
    color: #333;
  }
  .form-container input, .form-container select, .form-container textarea, .form-container button {
    display: block;
    width: 100%;
    margin: 0.5em 0 1em;
    padding: 0.8em;
    font-size: 1em;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .step-preview {
    background-color: #f9f9f9;
    padding: 0.5em;
    border-radius: 5px;
    margin-bottom: 1em;
  }
  .step-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1em;
  }
</style>

<div class="form-container">
  <h2>クエスト作成・編集</h2>
  <form method="post">
    <input type="text" name="title" placeholder="タイトル" value="{{ title }}" required>
    <textarea name="desc" placeholder="説明">{{ desc }}</textarea>
    <select name="type" required>
      <option value="">タイプを選択してください</option>
      {% for key, label in type_labels.items() %}
        <option value="{{ key }}" {% if quest_type == key %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>

    <div id="steps"></div>
    <button type="button" onclick="addStep()">＋ ステップを追加</button>
    <button type="submit">保存する</button>
  </form>
</div>

<script>
let stepIndex = 0;
const stepsContainer = document.getElementById("steps");
const loadedSteps = {{ steps_json | tojson | safe }};

window.onload = function () {
  if (loadedSteps && loadedSteps.length > 0) {
    loadedSteps.forEach(step => {
      addStep(step.label, step.type, step.choices || [], step.grid || {rows: 2, cols: 2});
    });
  }
};

function addStep(label = '', type = 'text', choices = [], grid = {rows: 2, cols: 2}) {
  const wrapper = document.createElement("div");
  wrapper.className = "step-preview";
  wrapper.innerHTML = `
    <label>ステップ内容</label>
    <input type="text" name="steps[${stepIndex}][label]" value="${label}" required>

    <label>タイプ</label>
    <select name="steps[${stepIndex}][type]" onchange="updatePreview(this, ${stepIndex})">
      <option value="text" ${type === 'text' ? 'selected' : ''}>記述</option>
      <option value="choice" ${type === 'choice' ? 'selected' : ''}>選択肢</option>
      <option value="grid" ${type === 'grid' ? 'selected' : ''}>グリッド</option>
    </select>

    <div id="option-area-${stepIndex}">
      ${generateOptionArea(stepIndex, type, choices, grid)}
    </div>
    <hr>
  `;
  stepsContainer.appendChild(wrapper);
  stepIndex++;
}

function generateOptionArea(index, type, choices, grid) {
  if (type === 'choice') {
    let html = '<label>選択肢（1つずつ）</label>';
    for (let i = 0; i < Math.max(choices.length, 1); i++) {
      const val = choices[i] || '';
      html += `<input type="text" name="steps[${index}][choices][]" value="${val}">`;
    }
    html += '<button type="button" onclick="addChoiceOption(' + index + ')">＋ 選択肢追加</button>';
    return html;
  } else if (type === 'grid') {
    return `
      <label>行数</label>
      <input type="number" name="steps[${index}][grid][rows]" value="${grid.rows || 2}" min="1">
      <label>列数</label>
      <input type="number" name="steps[${index}][grid][cols]" value="${grid.cols || 2}" min="1">
    `;
  } else {
    return '';
  }
}

function updatePreview(selectEl, index) {
  const newType = selectEl.value;
  const area = document.getElementById(`option-area-${index}`);
  area.innerHTML = generateOptionArea(index, newType, [], {});
}

function addChoiceOption(index) {
  const area = document.getElementById(`option-area-${index}`);
  const input = document.createElement("input");
  input.type = "text";
  input.name = `steps[${index}][choices][]`;
  input.placeholder = "選択肢を入力";
  area.insertBefore(input, area.lastElementChild);
}
</script>
{% endblock %}
